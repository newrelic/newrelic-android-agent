name: Compatibility Matrix Test

on:
  # Run every morning at 9 AM UTC (adjust to your timezone)
  schedule:
    - cron: '0 9 * * *'

  # Trigger on pull requests to develop or main
  pull_request:
    branches:
      - develop
      - main
    paths:
      - 'agent/**'
      - 'agent-core/**'
      - 'instrumentation/**'
      - 'plugins/gradle/**'
      - 'samples/agent-test-app/**'
      - '.github/workflows/compatibility-matrix-test.yml'
      - '.github/workflows/compatibility-matrix.json'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      combination:
        description: 'Test specific combination (leave empty for all)'
        required: false
        type: string
      clean_build:
        description: 'Clean build between tests'
        required: false
        type: boolean
        default: false

jobs:
  # Read the compatibility matrix and set up the test matrix
  setup:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up matrix from JSON
        id: set-matrix
        run: |
          # Read the compatibility matrix JSON
          MATRIX=$(cat .github/workflows/compatibility-matrix.json | jq -c '.combinations')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # Print the matrix for debugging
          echo "Test combinations:"
          echo "$MATRIX" | jq -r '.[] | "  - \(.name): AGP \(.agp), Gradle \(.gradle), Java \(.java), Kotlin \(.kotlin)"'

  # Run tests for each combination in the matrix
  test:
    name: Test ${{ matrix.combination.name }}
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false  # Continue testing other combinations even if one fails
      max-parallel: 1   # Run tests sequentially to avoid conflicts with shared files
      matrix:
        combination: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.combination.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.combination.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: ${{ matrix.combination.gradle }}
          cache-read-only: false

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/sdk
            ~/.android/avd
          key: android-sdk-${{ runner.os }}-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      - name: Grant execute permission for gradlew and test script
        run: |
          chmod +x gradlew
          chmod +x scripts/test-compatibility-matrix.sh

      - name: Publish Agent to Local Maven
        run: |
          ./gradlew publishToMavenLocal -x test -x functionalTests -x integrationTests
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Build Test App with ${{ matrix.combination.name }}
        id: build
        run: |
          echo "::group::Building with configuration"
          echo "AGP Version: ${{ matrix.combination.agp }}"
          echo "Gradle Version: ${{ matrix.combination.gradle }}"
          echo "Java Version: ${{ matrix.combination.java }}"
          echo "Kotlin Version: ${{ matrix.combination.kotlin }}"
          echo "::endgroup::"

          # Use the test script to properly handle version switching
          ./scripts/test-compatibility-matrix.sh --combination "${{ matrix.combination.name }}" --verbose
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Check APK was generated
        if: success()
        working-directory: samples/agent-test-app
        run: |
          APK_PATH="build/outputs/apk/release/agent-test-app-release-unsigned.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "âœ“ APK generated successfully: $APK_SIZE"
            echo "apk_generated=true" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          else
            echo "âœ— APK not found at $APK_PATH"
            echo "apk_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.combination.name }}-agp${{ matrix.combination.agp }}
          path: samples/agent-test-app/build/outputs/apk/release/*.apk
          retention-days: 7
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.combination.name }}
          path: |
            samples/agent-test-app/build/reports/
            samples/agent-test-app/build/outputs/logs/
          retention-days: 7
          if-no-files-found: ignore

  # Generate a summary report
  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: always()  # Run even if some tests failed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“Š Compatibility Matrix Test Results

          ## Test Configuration
          - **Triggered by**: ${{ github.event_name }}
          - **Run ID**: ${{ github.run_id }}
          - **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Test Matrix

          | Configuration | AGP | Gradle | Java | Kotlin | Status |
          |---------------|-----|--------|------|--------|--------|
          EOF

          # Parse matrix and add results
          MATRIX='${{ needs.setup.outputs.matrix }}'
          echo "$MATRIX" | jq -r '.[] |
            "| \(.name) | \(.agp) | \(.gradle) | \(.java) | \(.kotlin) | â³ Running |"
          ' >> $GITHUB_STEP_SUMMARY

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## ðŸ“ Notes
          - âœ… Green: Build succeeded and APK generated
          - âŒ Red: Build failed
          - â­ï¸ Skipped: Dependency failure

          EOF

  # Comment on PR with results (if this was triggered by a PR)
  comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Generate Comment Body
        id: comment
        run: |
          MATRIX='${{ needs.setup.outputs.matrix }}'

          cat > comment.md << 'EOF'
          ## ðŸ¤– Compatibility Matrix Test Results

          The agent was tested against multiple AGP/Gradle/Java/Kotlin combinations:

          | Configuration | AGP | Gradle | Java | Kotlin | Result |
          |---------------|-----|--------|------|--------|--------|
          EOF

          echo "$MATRIX" | jq -r '.[] |
            "| \(.name) | \(.agp) | \(.gradle) | \(.java) | \(.kotlin) | â³ See workflow |"
          ' >> comment.md

          echo "" >> comment.md
          echo "**View full results**: [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> comment.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });